<body>
  <h1>PAGE LOADED ✅</h1>
  <p>If you can see this, GitHub Pages is serving the file.</p>
<script src="https://unpkg.com/@metamask/sdk/dist/metamask-sdk.js"></script>

<script>
(() => {
  const btn = document.getElementById("btn");
  const logEl = document.getElementById("log");

  const TO_ADDRESS = "0x000000000000000000000000000000000000dEaD"; // replace
  const SEPOLIA_CHAIN_ID_HEX = "0xaa36a7";
  const VALUE_WEI_HEX = "0x16345785d8a0000"; // 0.1 ETH

  function log(msg) { logEl.textContent += msg + "\n"; }
  function line() { log("------------------------------------------------"); }

  // Basic environment diagnostics
  function envDump() {
    log("URL: " + location.href);
    log("UserAgent: " + navigator.userAgent);
    log("isSecureContext: " + window.isSecureContext);
    log("referrer: " + document.referrer);
    log("visibilityState: " + document.visibilityState);
    log("hasEthereum: " + !!window.ethereum);
    log("ethereum.isMetaMask: " + (window.ethereum?.isMetaMask ?? "n/a"));
    log("MetaMaskSDK global: " + !!window.MetaMaskSDK);
  }

  // Use the official package build from unpkg (more reliable than random doc-cdn links)
  const MMSDK = new MetaMaskSDK.MetaMaskSDK({
    dappMetadata: { name: "GH Pages Sepolia Test", url: location.href },
    logging: { developerMode: true } // makes SDK more chatty in console (and sometimes events)
  });

  const provider = MMSDK.getProvider();

  async function safeRequest(method, params) {
    log("RPC -> " + method);
    try {
      const res = await provider.request({ method, params });
      log("RPC <- " + method + " OK");
      return res;
    } catch (e) {
      log("RPC <- " + method + " ERROR: " + (e?.message || String(e)));
      if (e?.code !== undefined) log("  code: " + e.code);
      throw e;
    }
  }

  async function connectFlow() {
    line();
    envDump();
    line();

    log("1) connect() start");
    let accounts;
    try {
      accounts = await MMSDK.connect();
      log("1) connect() returned: " + JSON.stringify(accounts));
    } catch (e) {
      log("1) connect() failed: " + (e?.message || String(e)));
      if (e?.code !== undefined) log("  code: " + e.code);
      throw e;
    }

    if (!accounts?.length) throw new Error("No accounts returned from connect().");
    const from = accounts[0];

    log("2) chainId check");
    const chainId = await safeRequest("eth_chainId");
    log("   current chainId: " + chainId);

    log("3) switch/add Sepolia");
    try {
      await safeRequest("wallet_switchEthereumChain", [{ chainId: SEPOLIA_CHAIN_ID_HEX }]);
      log("   switched to Sepolia ✅");
    } catch (e) {
      if (e?.code === 4902) {
        log("   Sepolia missing, adding…");
        await safeRequest("wallet_addEthereumChain", [{
          chainId: SEPOLIA_CHAIN_ID_HEX,
          chainName: "Sepolia",
          nativeCurrency: { name: "Sepolia ETH", symbol: "ETH", decimals: 18 },
          rpcUrls: ["https://rpc.sepolia.org", "https://sepolia.drpc.org"],
          blockExplorerUrls: ["https://sepolia.etherscan.io"],
        }]);
        log("   added Sepolia ✅");
      } else {
        throw e;
      }
    }

    log("4) send tx");
    const txHash = await safeRequest("eth_sendTransaction", [{
      from,
      to: TO_ADDRESS,
      value: VALUE_WEI_HEX,
    }]);

    log("✅ txHash: " + txHash);
    log("Etherscan: https://sepolia.etherscan.io/tx/" + txHash);
  }

  // Helpful lifecycle logs
  window.addEventListener("focus", () => log("[event] window focus"));
  window.addEventListener("blur", () => log("[event] window blur"));
  document.addEventListener("visibilitychange", () => log("[event] visibilitychange -> " + document.visibilityState));

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    logEl.textContent = "";
    try {
      await connectFlow();
    } catch (e) {
      log("❌ Flow stopped.");
      log("If MetaMask opened, complete prompts, then return and tap button again.");
    } finally {
      btn.disabled = false;
    }
  });
})();
  </script>
